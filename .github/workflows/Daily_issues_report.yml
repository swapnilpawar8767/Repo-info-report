name: Weekly GitHub Repo Report

on:
  schedule:
    - cron: "30 2 * * 1"  # Every Monday at 08:00 IST (2:30 AM UTC)
  workflow_dispatch:

jobs:
  send-report:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: pip install requests pytz

      - name: Generate and send report
        env:
          DILESH_PAT_TOKEN: ${{ secrets.DILESH_PAT_TOKEN }}
          REPORT_WEBHOOK_URL: ${{ vars.REPORT_WEBHOOK_URL }}
        run: |
          python << 'EOF'
          import requests
          import os
          import datetime
          import pytz

          repos = [
              "swapnilpawar8767/Repo-info-report"
          ]

          # Use only one token from secrets.DILESH_PAT_TOKEN
          token = os.environ.get("DILESH_PAT_TOKEN")
          if not token:
              print("‚ùå No token found in DILESH_PAT_TOKEN. Exiting.")
              exit(1)

          headers = {
              "Authorization": f"token {token}",
              "Accept": "application/vnd.github.v3+json"
          }

          IST = pytz.timezone('Asia/Kolkata')
          report_date = datetime.date.today()
          separator = "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"

          seven_days_ago = datetime.datetime.now(IST) - datetime.timedelta(days=7)
          seven_days_ago_iso = seven_days_ago.isoformat()

          message_parts = []
          message_parts.append(f"üìä Weekly GitHub Repo Report - {report_date}\n\n")
          message_parts.append(f"Showing issues updated in the last 7 days (since {seven_days_ago.strftime('%Y-%m-%d')})\n\n")

          for repo in repos:
              repo_header = f"\n{separator}\n\n{' ' * 15}**{repo.upper()}**\n\n{separator}\n"
              message_parts.append(repo_header)

              url = f"https://api.github.com/repos/{repo}/issues?state=all&since={seven_days_ago_iso}&per_page=100&sort=updated"
              try:
                  response = requests.get(url, headers=headers)
                  if response.status_code == 401:
                      message_parts.append(f"‚ö†Ô∏è Unauthorized to fetch issues for {repo}. Check token permissions.\n{separator}\n")
                      continue
                  response.raise_for_status()
                  issues = response.json()
              except Exception as e:
                  message_parts.append(f"Failed to fetch issues for {repo}: {e}\n{separator}\n")
                  continue

              has_recent_issues = False
              open_count = 0
              closed_count = 0

              for issue in issues:
                  if "pull_request" in issue:
                      continue

                  updated_at_raw = issue.get("updated_at")
                  if not updated_at_raw:
                      continue
                  try:
                      dt_utc = datetime.datetime.strptime(updated_at_raw, "%Y-%m-%dT%H:%M:%SZ")
                      dt_utc = dt_utc.replace(tzinfo=datetime.timezone.utc)
                      dt_ist = dt_utc.astimezone(IST)
                  except:
                      continue

                  if dt_ist < seven_days_ago:
                      continue

                  has_recent_issues = True
                  title = issue.get("title", "")
                  issue_number = issue.get("number", "")
                  issue_url = issue.get("html_url", "")
                  status = "üÜï Open" if issue.get("state", "").lower() == "open" else "Closed"

                  if status == "üÜï Open":
                      open_count += 1
                  else:
                      closed_count += 1

                  updated_at = dt_ist.strftime("%Y-%m-%d %H:%M:%S")

                  milestone = issue.get("milestone")
                  milestone_name = "-"
                  due_date = "-"
                  if isinstance(milestone, dict):
                      milestone_name = milestone.get("title", "-")
                      due_date = milestone.get("due_on", "-")[:10] if milestone.get("due_on") else "-"

                  last_comment = "No comments"
                  if issue.get("comments", 0) > 0:
                      try:
                          comments_response = requests.get(issue["comments_url"], headers=headers)
                          comments_response.raise_for_status()
                          comments = comments_response.json()
                          if comments:
                              last_comment = comments[-1].get("body", "").replace("\n", " ")
                              if len(last_comment) > 50:
                                  last_comment = last_comment[:47] + "..."
                      except:
                          last_comment = "Failed to fetch comments"

                  message_parts.append(
                      f"üìå **#{issue_number} [{title}]({issue_url})**  \n"
                      f"**Last Comment** :: {last_comment}  \n"
                      f"**Due Date**     :: {due_date}  \n"
                      f"**Status**       :: {status}  \n"
                      f"**Milestone**    :: {milestone_name}  \n"
                      f"**Last Updated** :: {updated_at}  \n"
                      f"{separator}  \n"
                  )

              if not has_recent_issues:
                  message_parts.append(f"No issues updated in the last 7 days\n{separator}\n")

              # Per-repo summary box
              message_parts.append(
                  f"üìä **Summary (last 7 days)**  \n"
                  f"Open Issues   :: {open_count}  \n"
                  f"Closed Issues :: {closed_count}  \n"
                  f"{separator}  \n"
              )

          final_message = "".join(message_parts)

          webhook_url = os.environ.get("REPORT_WEBHOOK_URL")
          if not webhook_url:
              print("‚ùå REPORT_WEBHOOK_URL is empty. Exiting.")
              exit(1)

          payload = {"text": final_message, "markdown": True}
          try:
              resp = requests.post(webhook_url, json=payload)
              resp.raise_for_status()
              print("‚úÖ Report sent to Teams successfully!")
          except Exception as e:
              print(f"‚ùå Failed to send report to Teams: {e}")
          EOF
