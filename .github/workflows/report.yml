name: Daily GitHub Repo Report

on:
  schedule:
    - cron: "0 9 * * *"  # Daily at 09:00 UTC (2:30 PM IST)
  workflow_dispatch:

jobs:
  send-report:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: pip install requests

      - name: Generate and send report
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
        run: |
          python << 'EOF'
          import requests
          import os
          import datetime

          repos = [
              "swapnilpawar8767/Repo-info-report"  # Add more repos here
          ]

          headers = {
              "Authorization": f"token {os.environ['GITHUB_TOKEN']}",
              "Accept": "application/vnd.github.v3+json"
          }

          report_date = datetime.date.today()
          separator = "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

          # Build the report lines list
          report_lines = [f"ðŸ“Š Daily GitHub Repo Report - {report_date}", ""]

          for repo in repos:
              response = requests.get(
                  f"https://api.github.com/repos/{repo}/issues?state=all&per_page=5&sort=updated",
                  headers=headers,
              )
              issues = response.json()

              for issue in issues:
                  if "pull_request" in issue:
                      continue  # skip PRs

                  title = issue.get("title", "")
                  issue_number = issue.get("number")
                  issue_url = f"https://github.com/{repo}/issues/{issue_number}"
                  # Markdown clickable link for Teams
                  title_link = f"[{title}]({issue_url})"

                  status_raw = issue.get("state", "").lower()
                  status = "ðŸ†• Open" if status_raw == "open" else "Closed"
                  updated_at = issue.get("updated_at", "")[:10]

                  due_date = "-"
                  milestone = issue.get("milestone")
                  if milestone and milestone.get("due_on"):
                      due_date = milestone["due_on"][:10]

                  last_comment = "No comments"
                  if issue.get("comments", 0) > 0:
                      comments_response = requests.get(issue["comments_url"], headers=headers)
                      comments = comments_response.json()
                      if comments:
                          last_comment = comments[-1].get("body", "").replace("\n", " ")
                          if len(last_comment) > 50:
                              last_comment = last_comment[:47] + "..."

                  # Append issue block with explicit newlines and extra spacing for Teams
                  report_lines.append(separator)
                  report_lines.append(f"ðŸ“Œ {title_link} ({repo})")
                  report_lines.append(f"Last Comment :: {last_comment}")
                  report_lines.append(f"Due Date     :: {due_date}")
                  report_lines.append(f"Status       :: {status}")
                  report_lines.append(f"Last Updated :: {updated_at}")
                  report_lines.append("")  # blank line for spacing

          report_lines.append(separator)

          # Join with \n for new lines
          final_report = "\n".join(report_lines)

          # Wrap report in triple backticks to render as code block in Teams for preserving format
          payload = {
              "text": f"```\n{final_report}\n```"
          }

          resp = requests.post(os.environ["TEAMS_WEBHOOK_URL"], json=payload)
          resp.raise_for_status()
          print("âœ… Report sent to Teams successfully!")
          EOF
