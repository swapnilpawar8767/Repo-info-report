name: Daily Repo Report

on:
  workflow_dispatch:
  schedule:
    - cron: "0 9 * * *" # Runs every day at 9 AM UTC

jobs:
  daily-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Repo Variable
        run: echo "REPO=${GITHUB_REPOSITORY}" >> $GITHUB_ENV

      - name: Generate Report
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“Š **Daily GitHub Repo Report** ðŸ“Š" > report.md
          echo "" >> report.md

          echo "### Open Issues" >> report.md
          gh issue list --repo "$REPO" --state open --limit 50 \
            --json title,number,milestone,state,createdAt,updatedAt,url \
            --jq '.[] | "- [\(.title)](\(.url)) (Milestone: \(.milestone.title // "None"), State: \(.state), Updated: \(.updatedAt))"' \
            >> report.md

          echo "" >> report.md
          echo "### Recent Pull Requests" >> report.md
          gh pr list --repo "$REPO" --limit 20 \
            --json title,number,state,createdAt,updatedAt,url \
            --jq '.[] | "- [\(.title)](\(.url)) (State: \(.state), Updated: \(.updatedAt))"' \
            >> report.md

      - name: Send to Microsoft Teams
        env:
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
        run: |
          payload=$(jq -Rs '{text: .}' report.md)
          curl -H "Content-Type: application/json" \
               -d "$payload" \
               "$TEAMS_WEBHOOK_URL"
