name: Daily Commit Report

on:
  schedule:
    - cron: "0 5 * * *" # Runs daily at 05:00 UTC
  workflow_dispatch:

jobs:
  daily-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get commits from last 24 hours
        id: commits
        run: |
          REPOS=("owner/repo1" "owner/repo2") # <-- Add all your repos here
          REPORT=""

          for REPO in "${REPOS[@]}"; do
            COMMITS=$(gh api repos/$REPO/commits \
              --jq '.[] | select(.commit.author.date >= (now - 86400 | todate)) | "- " + .commit.author.name + ": " + .commit.message + " (" + .html_url + ")"')
            
            if [ -z "$COMMITS" ]; then
              COMMITS="No commits in last 24 hours"
            fi

            REPORT+="**Repository:** $REPO\n$COMMITS\n\n"
          done

          echo "report<<EOF" >> $GITHUB_OUTPUT
          echo "$REPORT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Send to Microsoft Teams
        uses: fjogeleit/http-request-action@v1
        with:
          url: ${{ secrets.TEAMS_WEBHOOK_URL }}
          method: POST
          contentType: application/json
          data: |
            {
              "type": "message",
              "attachments": [
                {
                  "contentType": "application/vnd.microsoft.card.adaptive",
                  "content": {
                    "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                    "type": "AdaptiveCard",
                    "version": "1.4",
                    "body": [
                      {
                        "type": "TextBlock",
                        "size": "Large",
                        "weight": "Bolder",
                        "text": "ðŸ“Œ Daily Commit Report"
                      },
                      {
                        "type": "TextBlock",
                        "text": "${{ steps.commits.outputs.report }}",
                        "wrap": true
                      }
                    ]
                  }
                }
              ]
            }
