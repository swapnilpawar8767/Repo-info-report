name: GitHub Repo Daily Report

on:
  schedule:
    - cron: "0 5 * * *" # Runs every day at 5:00 UTC
  workflow_dispatch:

jobs:
  daily-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Generate Daily Report
        id: generate
        run: |
          REPO="my-team-repo"
          DATE=$(date -u +"%Y-%m-%d")

          REPORT="**GitHub Repo Daily Report**\n\n"
          REPORT+="ðŸ“¦ **Repository:** $REPO\n"
          REPORT+="ðŸ“… **Date:** $DATE\n\n"
          REPORT+="---\n\n"

          # Pull Requests
          REPORT+="ðŸ”¹ **Pull Requests**\n"
          PRS=$(gh pr list --state all --json title,updatedAt,state -q '.[] | "- \(.title) â€” \(.state) (Last Updated: \(.updatedAt))"')
          if [ -z "$PRS" ]; then
            REPORT+="No pull requests found.\n"
          else
            REPORT+="$PRS\n"
          fi
          REPORT+="\n"

          # Issues
          REPORT+="ðŸ”¹ **Issues**\n"
          ISSUES=$(gh issue list --state all --json title,updatedAt,state,milestone,dueOn -q '.[] | "- \(.title) â€” \(.milestone.title // "No milestone") (Due: \(.dueOn // "N/A")) â€” Status: \(.state) â€” Last Updated: \(.updatedAt)"')
          if [ -z "$ISSUES" ]; then
            REPORT+="No issues found.\n"
          else
            REPORT+="$ISSUES\n"
          fi

          echo "report<<EOF" >> $GITHUB_OUTPUT
          echo -e "$REPORT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Send report to Microsoft Teams
        run: |
          curl -H "Content-Type: application/json" \
               -d "{\"text\": \"${{ steps.generate.outputs.report }}\"}" \
               ${{ secrets.MSTEAMS_WEBHOOK }}
