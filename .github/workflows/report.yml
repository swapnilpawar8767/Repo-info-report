name: Daily Project Status Report

on:
  workflow_dispatch:
  schedule:
    - cron: "0 5 * * *" # Runs daily at 05:00 UTC

jobs:
  send-status-report:
    runs-on: ubuntu-latest
    steps:
      - name: Get Issues and Pull Requests
        id: get_data
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const repo = context.repo.repo;
            const owner = context.repo.owner;

            // Fetch open and closed issues
            const { data: issues } = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'all',
              per_page: 100
            });

            const rows = issues.map(issue => {
              const lastUpdated = new Date(issue.updated_at).toISOString().replace('T', ' ').slice(0, 16);
              const dueDate = issue.milestone?.due_on
                ? new Date(issue.milestone.due_on).toISOString().split('T')[0]
                : 'â€”';
              const status = issue.state === 'open' ? 'â³ Open' : 'âœ… Closed';
              const lastComment = issue.comments > 0 ? issue.comments_url : 'â€”';

              return `| ${issue.title} | ${lastComment} | ${dueDate} | ${status} | ${lastUpdated} |`;
            }).join("\n");

            const header = `**ðŸ“Œ Daily Project Status â€“ ${repo}**\n\n` +
              "| Task / Description | Last Comment | Due Date | Status | Last Updated |\n" +
              "|--------------------|--------------|----------|--------|--------------|\n";

            return header + rows;

      - name: Send to Microsoft Teams
        uses: fjogeleit/http-request-action@v1
        with:
          url: ${{ secrets.TEAMS_WEBHOOK_URL }}
          method: POST
          contentType: application/json
          data: |
            {
              "type": "message",
              "attachments": [
                {
                  "contentType": "application/vnd.microsoft.card.adaptive",
                  "content": {
                    "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                    "type": "AdaptiveCard",
                    "version": "1.4",
                    "body": [
                      {
                        "type": "TextBlock",
                        "size": "Large",
                        "weight": "Bolder",
                        "text": "ðŸ“Œ Daily Project Status â€“ ${{ github.event.repository.name }}"
                      },
                      {
                        "type": "TextBlock",
                        "text": "${{ steps.get_data.outputs.result }}",
                        "wrap": true
                      }
                    ]
                  }
                }
              ]
            }
